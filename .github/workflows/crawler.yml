name: Hot News Crawler
on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: crawler-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML feedparser
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          
      - name: Clean frequency words file
        run: |
          if [ -f config/frequency_words.txt ]; then
            echo "åŸå§‹å…³é”®è¯æ–‡ä»¶è¡Œæ•°ï¼š"
            wc -l config/frequency_words.txt
            echo "æ¸…ç†å…³é”®è¯æ–‡ä»¶ï¼Œåˆ é™¤æ³¨é‡Šè¡Œ..."
            # åˆ é™¤æ‰€æœ‰ä»¥#å¼€å¤´çš„æ³¨é‡Šè¡Œ
            sed -i '/^#/d' config/frequency_words.txt
            echo "æ¸…ç†åçš„å…³é”®è¯æ–‡ä»¶è¡Œæ•°ï¼š"
            wc -l config/frequency_words.txt
            if [ ! -s config/frequency_words.txt ]; then
              echo "å…³é”®è¯æ–‡ä»¶ä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤å…³é”®è¯"
              echo -e "ä¸­å›½\nç¾å›½\nç»æµ\nç§‘æŠ€\nè‚¡å¸‚\nåä¸º\nç‰¹æ–¯æ‹‰\näººå·¥æ™ºèƒ½\nèŠ¯ç‰‡\nç–«æƒ…" > config/frequency_words.txt
            fi
            echo "æ¸…ç†åçš„å…³é”®è¯æ–‡ä»¶å‰20è¡Œï¼š"
            head -20 config/frequency_words.txt
          else
            echo "å…³é”®è¯æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
            mkdir -p config
            echo -e "ä¸­å›½\nç¾å›½\nç»æµ\nç§‘æŠ€\nè‚¡å¸‚\nåä¸º\nç‰¹æ–¯æ‹‰\näººå·¥æ™ºèƒ½\nèŠ¯ç‰‡\nç–«æƒ…" > config/frequency_words.txt
          fi
          
      - name: Verify required files
        run: |
          echo "æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          if [ ! -f config/config.yaml ]; then
            echo "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
            cat > config/config.yaml << 'EOF'
          app:
            version_check_url: "https://raw.githubusercontent.com/sansan0/TrendRadar/refs/heads/master/version"
            show_version_update: true

          crawler:
            request_interval: 1500
            enable_crawler: true
            use_proxy: false

          report:
            mode: "current"
            rank_threshold: 5

          notification:
            enable_notification: true
            webhooks:
              feishu_url: "{{FEISHU_WEBHOOK_URL}}"

          weight:
            rank_weight: 0.25
            frequency_weight: 0.65
            hotness_weight: 0.10

          platforms:
            - id: "wallstreetcn-hot"
              name: "åå°”è¡—è§é—»çƒ­æ¦œ"
            - id: "cls-hot"
              name: "è´¢è”ç¤¾çƒ­é—¨"
            - id: "jin10"
              name: "é‡‘åæ•°æ®"
            - id: "weibo"
              name: "å¾®åšçƒ­æœ"
            - id: "zhihu"
              name: "çŸ¥ä¹çƒ­æ¦œ"
            - id: "toutiao"
              name: "ä»Šæ—¥å¤´æ¡"
          EOF
          fi
          
      - name: Test Feishu connection
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "æµ‹è¯•é£ä¹¦è¿æ¥..."
          if [ -z "$FEISHU_WEBHOOK_URL" ]; then
            echo "é”™è¯¯ï¼šFEISHU_WEBHOOK_URL æœªè®¾ç½®"
            exit 1
          fi
          
          echo "é£ä¹¦webhook URLå·²è®¾ç½®"
          
          # å‘é€æµ‹è¯•æ¶ˆæ¯
          TEST_RESPONSE=$(curl -s -w "%{http_code}" -X POST "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "ğŸ”„ TrendRadar æµ‹è¯•æ¶ˆæ¯\næ—¶é—´ï¼š'"$(date '+%Y-%m-%d %H:%M:%S')"'\nçŠ¶æ€ï¼šçˆ¬è™«å³å°†å¯åŠ¨"
              }
            }')
          
          HTTP_CODE=$(echo "$TEST_RESPONSE" | tail -1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… é£ä¹¦è¿æ¥æµ‹è¯•æˆåŠŸ"
          else
            echo "âŒ é£ä¹¦è¿æ¥æµ‹è¯•å¤±è´¥ï¼ŒHTTPå“åº”ç ï¼š$HTTP_CODE"
          fi
          
      - name: Run crawler
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          GITHUB_ACTIONS: true
        run: |
          echo "å¼€å§‹æ›¿æ¢é…ç½®æ–‡ä»¶ä¸­çš„å˜é‡..."
          
          # ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨
          if [ ! -f config/config.yaml ]; then
            echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # å¤‡ä»½åŸå§‹é…ç½®
          cp config/config.yaml config/config.yaml.bak
          
          # æ›¿æ¢é£ä¹¦URL
          sed -i "s|{{FEISHU_WEBHOOK_URL}}|$FEISHU_WEBHOOK_URL|g" config/config.yaml
          
          echo "è¿è¡Œçˆ¬è™«..."
          # è¿è¡Œå¹¶è®°å½•è¯¦ç»†æ—¥å¿—
          python main.py 2>&1 | tee run.log
          
          echo "çˆ¬è™«è¿è¡Œå®Œæˆï¼Œæ£€æŸ¥è¾“å‡º..."
          if [ -d "output" ]; then
            echo "è¾“å‡ºæ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la output/
            
            if [ -f "output/latest_news.txt" ]; then
              NEWS_COUNT=$(grep -c "^\[" output/latest_news.txt 2>/dev/null || echo "0")
              echo "æœ¬æ¬¡çˆ¬å–åˆ° $NEWS_COUNT æ¡æ–°é—»"
              echo "æœ€æ–°æ–°é—»å‰5æ¡ï¼š"
              head -10 output/latest_news.txt
            else
              echo "æ²¡æœ‰ç”Ÿæˆæœ€æ–°æ–°é—»æ–‡ä»¶"
            fi
            
            if [ -f "output/notification_log.txt" ]; then
              echo "é€šçŸ¥æ—¥å¿—å†…å®¹ï¼š"
              cat output/notification_log.txt
            fi
          else
            echo "è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo "è¿è¡Œæ—¥å¿—å°¾éƒ¨ï¼š"
          tail -50 run.log
          
      - name: Check notification status
        if: always()
        run: |
          echo "æ£€æŸ¥é€šçŸ¥çŠ¶æ€..."
          if [ -f "output/notification_sent.txt" ]; then
            echo "âœ… é€šçŸ¥å·²å‘é€"
            echo "å‘é€æ—¶é—´ï¼š$(cat output/notification_sent.txt)"
          else
            echo "âš ï¸ é€šçŸ¥æœªå‘é€"
            echo "å¯èƒ½åŸå› ï¼š"
            echo "1. æ²¡æœ‰åŒ¹é…åˆ°æ–°é—»"
            echo "2. é£ä¹¦å‘é€å¤±è´¥"
            echo "3. é…ç½®æ–‡ä»¶é€šçŸ¥æœªå¯ç”¨"
          fi
          
      - name: Commit and push if changes
        if: success()
        env:
          BRANCH_NAME: ${{ github.event.repository.default_branch }}
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          git fetch origin $BRANCH_NAME
          git stash --include-untracked || echo "Nothing to stash"
          git reset --hard origin/$BRANCH_NAME
          git stash pop || echo "Nothing to pop"
          
          git add -A
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          TIMESTAMP=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
          git commit -m "Auto update at $TIMESTAMP"
          
          for i in {1..3}; do
            git pull --rebase origin $BRANCH_NAME && git push origin $BRANCH_NAME && {
              echo "Successfully pushed"
              exit 0
            }
            echo "Attempt $i failed, waiting $((i*5)) seconds..."
            sleep $((i*5))
          done
