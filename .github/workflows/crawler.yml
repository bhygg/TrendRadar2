name: å¤šé¢†åŸŸçƒ­ç‚¹ç›‘æ§
on:
  schedule:
    # å·¥ä½œæ—¥å¯†é›†ç›‘æ§ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - cron: "0 1,4,7,10 * * 1-5"    # 9:00, 12:00, 15:00, 18:00
    - cron: "30 2,5,8 * * 1-5"      # 10:30, 13:30, 16:30
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

concurrency:
  group: multi-field-monitor
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          
      - name: ğŸ“¦ å®‰è£…æ ¸å¿ƒä¾èµ–
        run: |
          python -m pip install --upgrade pip
          echo "å®‰è£…å¿…è¦çš„PythonåŒ…..."
          pip install requests beautifulsoup4 lxml pytz tzdata pyyaml feedparser
          
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          if [ -f requirements.txt ]; then
            echo "å‘ç°requirements.txtï¼Œå®‰è£…é¡¹ç›®ä¾èµ–..."
            pip install -r requirements.txt
          else
            echo "æœªæ‰¾åˆ°requirements.txtï¼Œè·³è¿‡"
          fi
          
      - name: ğŸ” æ£€æŸ¥é¡¹ç›®ç»“æ„
        run: |
          echo "å½“å‰ç›®å½•ç»“æ„:"
          ls -la
          echo ""
          echo "é…ç½®æ–‡ä»¶æ£€æŸ¥:"
          if [ -f "config/config.yaml" ]; then
            echo "âœ… config/config.yaml å­˜åœ¨"
          else
            echo "âš ï¸ config/config.yaml ä¸å­˜åœ¨"
            # åˆ›å»ºé…ç½®æ–‡ä»¶ç›®å½•
            mkdir -p config
          fi
          
          if [ -f "config/frequency_words.txt" ]; then
            echo "âœ… config/frequency_words.txt å­˜åœ¨"
          else
            echo "âš ï¸ config/frequency_words.txt ä¸å­˜åœ¨"
          fi
          
      - name: ğŸš€ è¿è¡Œåˆ†ç±»ç›‘æ§
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TZ: "Asia/Shanghai"
        run: |
          echo "======================================"
          echo "ğŸŒ å¤šé¢†åŸŸçƒ­ç‚¹ç›‘æ§å¯åŠ¨"
          echo "ğŸ“… åŒ—äº¬æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "======================================"
          
          echo "æ£€æŸ¥Pythonç¯å¢ƒ:"
          python --version
          pip list | grep -E "yaml|feedparser|requests"
          
          echo ""
          echo "è¿è¡Œç›‘æ§ç¨‹åº..."
          if [ -f "main.py" ]; then
            python main.py
            EXIT_CODE=$?
            echo "ç¨‹åºé€€å‡ºä»£ç : $EXIT_CODE"
          else
            echo "âŒ é”™è¯¯: main.py æ–‡ä»¶ä¸å­˜åœ¨"
            ls -la *.py || echo "æ²¡æœ‰æ‰¾åˆ°Pythonæ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… ç›‘æ§å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
      - name: ğŸ’¾ ä¿å­˜ç›‘æ§ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-results-${{ github.run_number }}
          path: |
            output/
            logs/
            config/
          retention-days: 14
          
      - name: ğŸ“Š ç”Ÿæˆç›‘æ§æŠ¥å‘Š
        if: success()
        run: |
          echo "ğŸ“ˆ ç›‘æ§é¢†åŸŸï¼šå¤–äº¤æ”¿æ²»ã€å®è§‚ç»æµã€é‡‘èã€ç§‘æŠ€ã€è¡Œä¸šã€ç¤¾ä¼šæ°‘ç”Ÿã€ä¼ä¸šé£é™©ã€åœ°ç¼˜æ”¿æ²»"
          echo "ğŸ•’ ç›‘æ§æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ·ï¸ è¿è¡Œç¼–å·ï¼š${{ github.run_number }}"
