name: å¤šé¢†åŸŸçƒ­ç‚¹ç›‘æ§
on:
  schedule:
    # å·¥ä½œæ—¥å¯†é›†ç›‘æ§ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - cron: "0 1,4,7,10 * * 1-5"    # 9:00, 12:00, 15:00, 18:00
    - cron: "30 2,5,8 * * 1-5"      # 10:30, 13:30, 16:30
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

concurrency:
  group: multi-field-monitor
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml pytz tzdata
          
      - name: âš™ï¸ åˆ›å»ºé…ç½®æ–‡ä»¶
        run: |
          # åˆ›å»ºé…ç½®æ–‡ä»¶ç›®å½•
          mkdir -p config output logs
          
          # ç”Ÿæˆåˆ†ç±»å…³é”®è¯é…ç½®æ–‡ä»¶
          echo "æ­£åœ¨ç”Ÿæˆåˆ†ç±»å…³é”®è¯é…ç½®..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ ä»£ç å°†ä¸Šé¢æä¾›çš„å…³é”®è¯é…ç½®å†™å…¥æ–‡ä»¶
          
      - name: ğŸš€ è¿è¡Œåˆ†ç±»ç›‘æ§
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TZ: "Asia/Shanghai"
        run: |
          echo "======================================"
          echo "ğŸŒ å¤šé¢†åŸŸçƒ­ç‚¹ç›‘æ§å¯åŠ¨"
          echo "ğŸ“… åŒ—äº¬æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "======================================"
          
          # è¿è¡Œç›‘æ§ç¨‹åº
          python main.py
          
          echo "âœ… ç›‘æ§å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
      - name: ğŸ’¾ ä¿å­˜ç›‘æ§ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-results-${{ github.run_number }}
          path: |
            output/
            logs/
            config/
          retention-days: 14
          
      - name: ğŸ“Š ç”Ÿæˆç›‘æ§æŠ¥å‘Š
        if: success()
        run: |
          echo "ç”Ÿæˆç›‘æ§ç»Ÿè®¡æŠ¥å‘Š..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ ç»Ÿè®¡ä»£ç 
          echo "ğŸ“ˆ ç›‘æ§é¢†åŸŸï¼šå¤–äº¤æ”¿æ²»ã€å®è§‚ç»æµã€é‡‘èã€ç§‘æŠ€ã€è¡Œä¸šã€ç¤¾ä¼šæ°‘ç”Ÿã€ä¼ä¸šé£é™©ã€åœ°ç¼˜æ”¿æ²»"
          echo "ğŸ•’ ç›‘æ§æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
