name: ğŸ­ ä¸“ä¸šäº§ä¸šå†…å‚ç›‘æµ‹ç³»ç»Ÿ
on:
  schedule:
    - cron: "0 * * * *"  # æ¯å°æ—¶æ•´ç‚¹
    - cron: "0 0 * * *"  # æ¯å¤©UTCæ—¶é—´0ç‚¹
  
  workflow_dispatch:
    inputs:
      operation:
        description: 'æ“ä½œç±»å‹'
        required: false
        default: 'collect'
        type: choice
        options:
          - collect
          - report

concurrency:
  group: industrial-intelligence-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.10'
  TZ: 'Asia/Shanghai'

jobs:
  # ä»»åŠ¡1ï¼šæ•°æ®é‡‡é›†
  collect:
    if: github.event_name == 'schedule' || (github.event.inputs.operation == 'collect')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: âš™ï¸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ğŸ”§ ç”Ÿæˆæ—¶é—´æˆ³
        id: timestamp
        run: |
          echo "timestamp=$(TZ='Asia/Shanghai' date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "date=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          
      - name: ğŸ“¡ é‡‡é›†æ•°æ®
        env:
          GITHUB_ACTIONS: true
          ENABLE_NOTIFICATION: "false"
          REPORT_MODE: "incremental"
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "ğŸ• å¼€å§‹é‡‡é›†æ•°æ®..."
          python main.py
          echo "âœ… æ•°æ®é‡‡é›†å®Œæˆ"
          
      - name: ğŸ“ å¤„ç†è¾“å‡ºæ–‡ä»¶
        run: |
          echo "ğŸ“‚ æ£€æŸ¥è¾“å‡ºæ–‡ä»¶..."
          
          # åˆ›å»ºdataç›®å½•
          mkdir -p data/hourly
          
          # æŸ¥æ‰¾æœ€æ–°çš„txtæ–‡ä»¶
          latest_txt=$(find output -name "*.txt" -type f | head -1)
          
          if [ -n "$latest_txt" ]; then
            echo "ğŸ“„ æ‰¾åˆ°txtæ–‡ä»¶: $latest_txt"
            
            # å°†txtå†…å®¹è½¬æ¢ä¸ºç®€å•çš„jsonæ ¼å¼
            output_file="data/hourly/data_${{ steps.timestamp.outputs.timestamp }}.json"
            
            # åˆ›å»ºJSONæ•°æ®
            echo '{
  "timestamp": "'$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')'",
  "date": "'${{ steps.timestamp.outputs.date }}'",
  "source_files": "'"$latest_txt"'",
  "count": '$(wc -l < "$latest_txt" 2>/dev/null || echo 0)',
  "news": []' > "$output_file"
            
            # åˆ›å»ºlatest_news.jsoné“¾æ¥
            cp "$output_file" data/latest_news.json
            
            echo "âœ… JSONæ–‡ä»¶å·²åˆ›å»º: $output_file"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°txtæ–‡ä»¶ï¼Œåˆ›å»ºç©ºJSONæ–‡ä»¶"
            
            output_file="data/hourly/data_${{ steps.timestamp.outputs.timestamp }}.json"
            echo '{
  "timestamp": "'$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')'",
  "date": "'${{ steps.timestamp.outputs.date }}'",
  "count": 0,
  "news": []
}' > "$output_file"
            
            cp "$output_file" data/latest_news.json
          fi
          
      - name: ğŸ“ æäº¤æ•°æ®
        if: success()
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git add data/
          
          if git diff --cached --quiet; then
            echo "ğŸ“­ æ— æ–°æ•°æ®éœ€è¦æäº¤"
          else
            git commit -m "ğŸ“Š æ•°æ®æ›´æ–°: ${{ steps.timestamp.outputs.timestamp }}"
            
            for i in {1..3}; do
              git pull --rebase && git push && {
                echo "âœ… æ¨é€æˆåŠŸ"
                break
              } || {
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
                sleep 10
              }
            done
          fi
  
  # ä»»åŠ¡2ï¼šæ—¥æŠ¥ç”Ÿæˆ
  report:
    needs: collect
    if: github.event_name == 'schedule' || (github.event.inputs.operation == 'report')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: âš™ï¸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“… è®¾ç½®æ—¥æœŸ
        id: date
        run: |
          target_date=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          echo "target_date=$target_date" >> $GITHUB_OUTPUT
          
      - name: ğŸ“‹ ç”Ÿæˆæ—¥æŠ¥
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          ENABLE_NOTIFICATION: "true"
          REPORT_MODE: "daily"
        run: |
          echo "ğŸ“‹ ç”Ÿæˆæ—¥æŠ¥..."
          python main.py
          
      - name: ğŸ“¤ å‘é€é£ä¹¦é€šçŸ¥
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "ğŸ“¨ å‘é€é£ä¹¦é€šçŸ¥..."
          
          # æŸ¥æ‰¾æœ€æ–°çš„HTMLæŠ¥å‘Š
          latest_html=$(find output -name "*.html" -type f | head -1)
          
          if [ -n "$latest_html" ] && [ -n "$FEISHU_WEBHOOK_URL" ]; then
            # å‘é€ç®€å•é€šçŸ¥
            message='{
              "msg_type": "text",
              "content": {
                "text": "ç±»å‹ï¼šwebhook content.daily_report\nğŸ“Š äº§ä¸šå†…å‚æ—¥æŠ¥ '${{ steps.date.outputs.target_date }}'\n\nâœ… æ—¥æŠ¥å·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹è¾“å‡ºæ–‡ä»¶ã€‚\n\nç”Ÿæˆæ—¶é—´: '$(TZ="Asia/Shanghai" date +"%Y-%m-%d %H:%M:%S")'"
              }
            }'
            
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "$message" \
              "$FEISHU_WEBHOOK_URL"
          fi
          
      - name: ğŸ“ æäº¤æŠ¥å‘Š
        if: success()
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git add output/
          
          if git diff --cached --quiet; then
            echo "ğŸ“­ æ— æ–°æŠ¥å‘Šéœ€è¦æäº¤"
          else
            git commit -m "ğŸ“‹ æ—¥æŠ¥ç”Ÿæˆ: ${{ steps.date.outputs.target_date }}"
            git push
          fi
