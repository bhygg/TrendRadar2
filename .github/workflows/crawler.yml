name: ğŸ•·ï¸ çƒ­ç‚¹é›·è¾¾ - å…¨å¹³å°æŠ“å–

on:
  schedule:
    # ä½¿ç”¨UTCæ—¶é—´ï¼Œä»¥ä¸‹ä¸ºåŒ—äº¬æ—¶é—´ 8:00-22:00 æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆè¯·æ ¹æ®GitHub Actioné™é¢è°ƒæ•´ï¼‰
    - cron: "*/30 0-14 * * *"
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

concurrency:
  group: crawler-${{ github.ref_name }}
  cancel-in-progress: true # é˜²æ­¢é‡å¤æ’é˜Ÿ

permissions:
  contents: write # å¿…é¡»ï¼šå…è®¸å·¥ä½œæµæäº¤æ›´æ”¹

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 40 # å› å¹³å°å¢å¤šï¼Œé€‚å½“å¢åŠ è¶…æ—¶æ—¶é—´

    steps:
      - name: "ğŸ“¥ æ£€å‡ºä»£ç "
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true

      - name: "ğŸ è®¾ç½®Pythonç¯å¢ƒ"
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: "ğŸ“¦ å®‰è£…ä¾èµ–"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: "âœ… éªŒè¯é…ç½®æ–‡ä»¶"
        run: |
          echo "=== é…ç½®æ–‡ä»¶ç»“æ„éªŒè¯ ==="
          echo "1. æ£€æŸ¥æ ¸å¿ƒé…ç½®æ–‡ä»¶..."
          if [ ! -f config/config.yaml ]; then
            echo "âŒ é”™è¯¯: config/config.yaml ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f config/frequency_words.txt ]; then
            echo "âŒ é”™è¯¯: config/frequency_words.txt ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "2. ç»Ÿè®¡é…ç½®è§„æ¨¡..."
          PLATFORM_COUNT=$(grep -c "^\s*- id:" config/config.yaml)
          KEYWORD_GROUP_COUNT=$(grep -c "^\# =====" config/frequency_words.txt || echo "0") # å¤„ç†å¯èƒ½æ²¡æœ‰åŒ¹é…çš„æƒ…å†µ
          echo "   - é…ç½®å¹³å°æ•°: $PLATFORM_COUNT ä¸ª"
          echo "   - å…³é”®è¯ç»„æ•°: $KEYWORD_GROUP_COUNT ç»„"
          
          echo "3. æ£€æŸ¥å¹³å°æƒé‡åˆ†å±‚..."
          # å®‰å…¨åœ°æå–ç¬¬ä¸€æ¢¯é˜Ÿåç§°
          echo -n "   ç¬¬ä¸€æ¢¯é˜Ÿ(2.0): "
          grep -A1 "ç¬¬ä¸€æ¢¯é˜Ÿ" config/config.yaml | grep "name:" | sed 's/.*: //' | tr '\n' ' '
          echo "" # æ¢è¡Œ
          
          # å®‰å…¨åœ°æå–ç¬¬å…«æ¢¯é˜Ÿåç§°
          echo -n "   ç¬¬å…«æ¢¯é˜Ÿ(0.6): "
          grep -A1 "ç¬¬å…«æ¢¯é˜Ÿ" config/config.yaml | grep "name:" | sed 's/.*: //' | tr '\n' ' '
          echo "" # æ¢è¡Œ
          
          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
