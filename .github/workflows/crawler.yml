name: "èˆ†è®ºçƒ­ç‚¹ç›‘æµ‹ç³»ç»Ÿ"

on:
  # æ›´é¢‘ç¹çš„ç›‘æµ‹ï¼šæ¯30åˆ†é’Ÿä¸€æ¬¡
  schedule:
    - cron: "*/30 * * * *"  # æ¯30åˆ†é’Ÿ
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: false
        default: 'monitor'
        type: choice
        options:
          - monitor
          - daily
          - emergency

concurrency:
  group: hotspot-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.10'
  TZ: 'Asia/Shanghai'

jobs:
  # ä»»åŠ¡1ï¼šå®æ—¶ç›‘æµ‹ï¼ˆæ¯30åˆ†é’Ÿï¼‰
  realtime-monitor:
    if: github.event_name == 'schedule' || (github.event.inputs.mode == 'monitor')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: å®æ—¶ç›‘æµ‹
        env:
          GITHUB_ACTIONS: true
          ENABLE_NOTIFICATION: "true"
          REPORT_MODE: "incremental"  # å¢é‡æ¨¡å¼ï¼Œåªå…³æ³¨æ–°çƒ­ç‚¹
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "ğŸ” å¼€å§‹èˆ†è®ºçƒ­ç‚¹å®æ—¶ç›‘æµ‹..."
          echo "â° ç›‘æµ‹æ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          
          # è¿è¡Œç›‘æµ‹
          python main.py
          
          echo "âœ… å®æ—¶ç›‘æµ‹å®Œæˆ"
          
      - name: æ£€æŸ¥ç´§æ€¥äº‹ä»¶
        if: success()
        run: |
          echo "ğŸš¨ æ£€æŸ¥ç´§æ€¥äº‹ä»¶..."
          # å¯ä»¥æ·»åŠ ç´§æ€¥äº‹ä»¶æ£€æŸ¥é€»è¾‘
          
      - name: æäº¤æ•°æ®
        if: success()
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git add output/ data/
          
          if git diff --cached --quiet; then
            echo "ğŸ“­ æ— æ–°æ•°æ®éœ€è¦æäº¤"
          else
            TIMESTAMP=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
            git commit -m "ğŸ“ˆ çƒ­ç‚¹ç›‘æµ‹æ›´æ–°: $TIMESTAMP"
            
            for i in {1..3}; do
              if git pull --rebase && git push; then
                echo "âœ… æ¨é€æˆåŠŸ"
                break
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’..."
                sleep 10
              fi
            done
          fi
  
  # ä»»åŠ¡2ï¼šæ¯æ—¥æ±‡æ€»ï¼ˆæ¯å¤©8ç‚¹åŒ—äº¬æ—¶é—´ï¼‰
  daily-summary:
    if: github.event.schedule == '0 0 * * *' || (github.event.inputs.mode == 'daily')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          
      - name: ç”Ÿæˆæ¯æ—¥çƒ­ç‚¹æ±‡æ€»
        id: summary
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          ENABLE_NOTIFICATION: "true"
          REPORT_MODE: "daily"
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ¯æ—¥çƒ­ç‚¹æ±‡æ€»..."
          
          DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          echo "ğŸ“… æ±‡æ€»æ—¥æœŸ: $DATE"
          
          # è¿è¡Œæ—¥æŠ¥ç”Ÿæˆ
          python main.py
          
          echo "âœ… æ¯æ—¥æ±‡æ€»å®Œæˆ"
          
          # ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
          echo "ğŸ“‹ ç”Ÿæˆçƒ­ç‚¹åˆ†ææŠ¥å‘Š..."
          
      - name: å‘é€æ±‡æ€»æŠ¥å‘Š
        if: success()
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "ğŸ“¨ å‘é€æ¯æ—¥æ±‡æ€»æŠ¥å‘Š..."
          
          # æŠ¥å‘Šå°†ç”±main.pyè‡ªåŠ¨å‘é€
          echo "âœ… é£ä¹¦é€šçŸ¥å·²ç”±ä¸»ç¨‹åºå¤„ç†"
          
      - name: å½’æ¡£æŠ¥å‘Š
        run: |
          DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          mkdir -p reports/archive
          
          if [ -f "output/$DATE/html/å½“æ—¥æ±‡æ€».html" ]; then
            cp "output/$DATE/html/å½“æ—¥æ±‡æ€».html" "reports/archive/hotspot_summary_$DATE.html"
          fi
          
      - name: æäº¤æ±‡æ€»
        if: success()
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git add reports/archive/
          
          if git diff --cached --quiet; then
            echo "ğŸ“­ æ— æ–°æŠ¥å‘Šéœ€è¦æäº¤"
          else
            DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
            git commit -m "ğŸ“‹ çƒ­ç‚¹æ¯æ—¥æ±‡æ€»: $DATE"
            git push
          fi
  
  # ä»»åŠ¡3ï¼šçƒ­ç‚¹è¶‹åŠ¿åˆ†æï¼ˆæ¯å‘¨ä¸€ï¼‰
  weekly-analysis:
    if: github.event.schedule == '0 0 * * 1'  # æ¯å‘¨ä¸€UTCæ—¶é—´0ç‚¹
    runs-on: ubuntu-latest
    timeout-minutes: 40
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ç”Ÿæˆå‘¨åº¦çƒ­ç‚¹æŠ¥å‘Š
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "ğŸ“ˆ ç”Ÿæˆå‘¨åº¦çƒ­ç‚¹è¶‹åŠ¿æŠ¥å‘Š..."
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ å‘¨åº¦åˆ†æé€»è¾‘
          echo "ğŸ“Š æ”¶é›†è¿‡å»7å¤©çƒ­ç‚¹æ•°æ®..."
          
          # å‘é€å‘¨æŠ¥é€šçŸ¥
          WEEK=$(TZ='Asia/Shanghai' date +'%Yå¹´%Uå‘¨')
          MESSAGE='{
            "msg_type": "text",
            "content": {
              "text": "ç±»å‹ï¼šwebhook content.weekly_report\nğŸ“ˆ èˆ†è®ºçƒ­ç‚¹å‘¨åº¦æŠ¥å‘Š '${WEEK}'\n\nğŸ” æœ¬å‘¨çƒ­ç‚¹è¶‹åŠ¿åˆ†æå·²ç”Ÿæˆã€‚\n\nâ° ç”Ÿæˆæ—¶é—´: '$(TZ="Asia/Shanghai" date +"%Y-%m-%d %H:%M:%S")'"
            }
          }'
          
          if [ -n "$FEISHU_WEBHOOK_URL" ]; then
            curl -s -X POST -H "Content-Type: application/json" -d "$MESSAGE" "$FEISHU_WEBHOOK_URL"
          fi
          
      - name: æ¸…ç†æ—§æ•°æ®
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§æ•°æ®..."
          find output -type f -mtime +30 -delete
          find data -type f -mtime +30 -delete
