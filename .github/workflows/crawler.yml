name: "ä¸“ä¸šäº§ä¸šå†…å‚ç›‘æµ‹ç³»ç»Ÿ"

on:
  # æ•°æ®é‡‡é›†ï¼šæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
  schedule:
    - cron: "0 * * * *"  # æ¯å°æ—¶æ•´ç‚¹
  
  # æ—¥æŠ¥ç”Ÿæˆï¼šæ¯å¤©åŒ—äº¬æ—¶é—´8ç‚¹ï¼ˆUTCæ—¶é—´0ç‚¹ï¼‰
    - cron: "0 0 * * *"  # æ¯å¤©UTCæ—¶é—´0ç‚¹
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: false
        default: 'test'
        type: choice
        options:
          - test
          - daily
          - incremental
      send_notification:
        description: 'å‘é€é€šçŸ¥'
        required: false
        default: 'true'
        type: boolean

concurrency:
  group: crawler-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.10'
  TZ: 'Asia/Shanghai'

jobs:
  # ä»»åŠ¡1ï¼šæ•°æ®é‡‡é›†ï¼ˆæ¯å°æ—¶è¿è¡Œï¼‰
  collect-data:
    if: github.event_name == 'schedule' || (github.event.inputs.mode == 'incremental')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: æ•°æ®é‡‡é›†
        env:
          GITHUB_ACTIONS: true
          ENABLE_NOTIFICATION: "false"
          REPORT_MODE: "incremental"
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "ğŸ• å¼€å§‹æ•°æ®é‡‡é›†..."
          python main.py
          echo "âœ… æ•°æ®é‡‡é›†å®Œæˆ"
          
      - name: æäº¤æ•°æ®
        if: success()
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git add output/
          
          if git diff --cached --quiet; then
            echo "ğŸ“­ æ— æ–°æ•°æ®éœ€è¦æäº¤"
          else
            TIMESTAMP=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
            git commit -m "ğŸ“Š æ•°æ®é‡‡é›†: $TIMESTAMP"
            
            for i in {1..3}; do
              echo "å°è¯•æ¨é€ ($i/3)..."
              if git pull --rebase && git push; then
                echo "âœ… æ¨é€æˆåŠŸ"
                break
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’..."
                sleep 10
              fi
            done
          fi
  
  # ä»»åŠ¡2ï¼šæ—¥æŠ¥ç”Ÿæˆï¼ˆæ¯å¤©è¿è¡Œï¼‰
  generate-report:
    needs: collect-data
    if: github.event.schedule == '0 0 * * *' || (github.event.inputs.mode == 'daily') || (github.event.inputs.mode == 'test')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          
      - name: ç”Ÿæˆæ—¥æŠ¥
        id: generate
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          ENABLE_NOTIFICATION: ${{ github.event.inputs.send_notification || 'true' }}
          REPORT_MODE: "daily"
          GITHUB_ACTIONS: true
        run: |
          echo "ğŸ“‹ ç”Ÿæˆäº§ä¸šå†…å‚æ—¥æŠ¥..."
          
          # è·å–å½“å‰æ—¥æœŸ
          DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          echo "ğŸ“… æŠ¥å‘Šæ—¥æœŸ: $DATE"
          
          # è¿è¡Œæ—¥æŠ¥ç”Ÿæˆ
          python main.py
          
          echo "âœ… æ—¥æŠ¥ç”Ÿæˆå®Œæˆ"
          
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æŠ¥å‘Š
          if [ -f "output/$DATE/txt/å½“æ—¥æ±‡æ€».txt" ] || [ -f "output/$(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥')/txt/å½“æ—¥æ±‡æ€».txt" ]; then
            echo "report_generated=true" >> $GITHUB_OUTPUT
          else
            echo "report_generated=false" >> $GITHUB_OUTPUT
          fi
          
      - name: æ£€æŸ¥é£ä¹¦é€šçŸ¥
        if: steps.generate.outputs.report_generated == 'true' && env.FEISHU_WEBHOOK_URL != ''
        run: |
          echo "ğŸ“¨ æ£€æŸ¥é£ä¹¦é€šçŸ¥çŠ¶æ€..."
          echo "âœ… é£ä¹¦é€šçŸ¥å°†ç”±main.pyè‡ªåŠ¨å‘é€"
          
      - name: æäº¤æŠ¥å‘Š
        if: success()
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git add output/
          
          if git diff --cached --quiet; then
            echo "ğŸ“­ æ— æ–°æŠ¥å‘Šéœ€è¦æäº¤"
          else
            DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
            git commit -m "ğŸ“‹ äº§ä¸šå†…å‚æ—¥æŠ¥: $DATE"
            git push
          fi
          
      - name: æ¸…ç†æ—§æ•°æ®
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†7å¤©å‰çš„æ•°æ®..."
          find output -type f -name "*.txt" -mtime +7 -delete
          find output -type f -name "*.html" -mtime +7 -delete
