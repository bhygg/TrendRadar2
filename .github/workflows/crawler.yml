name: ğŸ•·ï¸ çƒ­ç‚¹é›·è¾¾ - å…¨å¹³å°æŠ“å–

on:
  schedule:
    # ä½¿ç”¨UTCæ—¶é—´ï¼Œä»¥ä¸‹ä¸ºåŒ—äº¬æ—¶é—´ 8:00-22:00 æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆè¯·æ ¹æ®GitHub Actioné™é¢è°ƒæ•´ï¼‰
    - cron: "*/30 0-14 * * *"
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

concurrency:
  group: crawler-${{ github.ref_name }}
  cancel-in-progress: true # é˜²æ­¢é‡å¤æ’é˜Ÿ

permissions:
  contents: write # å¿…é¡»ï¼šå…è®¸å·¥ä½œæµæäº¤æ›´æ”¹

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 40 # å› å¹³å°å¢å¤šï¼Œé€‚å½“å¢åŠ è¶…æ—¶æ—¶é—´

    steps:
      - name: "ğŸ“¥ æ£€å‡ºä»£ç "
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true

      - name: "ğŸ è®¾ç½®Pythonç¯å¢ƒ"
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: "ğŸ“¦ å®‰è£…ä¾èµ–"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: "âœ… éªŒè¯é…ç½®æ–‡ä»¶"
        run: |
          echo "=== é…ç½®æ–‡ä»¶ç»“æ„éªŒè¯ ==="
          echo "1. æ£€æŸ¥æ ¸å¿ƒé…ç½®æ–‡ä»¶..."
          if [ ! -f config/config.yaml ]; then
            echo "âŒ é”™è¯¯: config/config.yaml ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f config/frequency_words.txt ]; then
            echo "âŒ é”™è¯¯: config/frequency_words.txt ä¸å­˜åœ¨"
            exit 1
          fi

          echo "2. ç»Ÿè®¡é…ç½®è§„æ¨¡..."
          PLATFORM_COUNT=$(grep -c "^\s*- id:" config/config.yaml)
          KEYWORD_GROUP_COUNT=$(grep -c "^\# =====" config/frequency_words.txt)
          echo "   - é…ç½®å¹³å°æ•°: $PLATFORM_COUNT ä¸ª"
          echo "   - å…³é”®è¯ç»„æ•°: $KEYWORD_GROUP_COUNT ç»„"

          echo "3. æ£€æŸ¥å¹³å°æƒé‡åˆ†å±‚..."
          echo "   ç¬¬ä¸€æ¢¯é˜Ÿ(2.0):" $(grep -A1 "ç¬¬ä¸€æ¢¯é˜Ÿ" config/config.yaml | grep "name:" | sed 's/.*: //')
          echo "   ç¬¬å…«æ¢¯é˜Ÿ(0.6):" $(grep -A1 "ç¬¬å…«æ¢¯é˜Ÿ" config/config.yaml | grep "name:" | sed 's/.*: //')
          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      - name: "ğŸš€ è¿è¡Œçƒ­ç‚¹é›·è¾¾çˆ¬è™«"
        env:
          # æ ¸å¿ƒæ ‡è¯†
          GITHUB_ACTIONS: true
          
          # é€šçŸ¥æœåŠ¡ Secrets (è¯·åœ¨ä»“åº“ Settings -> Secrets ä¸­é…ç½®)
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          BARK_URL: ${{ secrets.BARK_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
        run: |
          echo "å¼€å§‹å…¨å¹³å°çƒ­ç‚¹æŠ“å–..."
          echo "========================================"
          echo "æŠ“å–ç­–ç•¥ï¼šå¹¿åº¦è¦†ç›– + æ·±åº¦ä¼˜å…ˆ + æ™ºèƒ½é™å™ª"
          echo "å¹³å°åˆ†å±‚ï¼š8ä¸ªæ¢¯é˜Ÿ (æƒé‡ 2.0 ~ 0.6)"
          echo "å…³é”®è¯ç»„ï¼š7å¤§æ¨¡å— + æ™ºèƒ½é™å™ªè¿‡æ»¤å™¨"
          echo "========================================"
          
          # è¿è¡Œä¸»ç¨‹åºå¹¶è¾“å‡ºæ—¥å¿—
          python main.py 2>&1 | tee -a crawl_full.log
          
          echo "========================================"
          echo "ä¸»ç¨‹åºæ‰§è¡Œå®Œæ¯•ã€‚"
          
          # æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰æ˜æ˜¾çš„é”™è¯¯
          if grep -i "error\|exception\|failed" crawl_full.log | grep -v "DEBUG"; then
            echo "âš ï¸  æ—¥å¿—ä¸­å‘ç°å¯èƒ½çš„é”™è¯¯æˆ–å¼‚å¸¸ï¼Œè¯¦æƒ…è§ä¸Šæ–¹è¾“å‡ºã€‚"
          else
            echo "âœ… ä¸»ç¨‹åºè¿è¡Œæœªå‘ç°æ˜æ˜¾é”™è¯¯ã€‚"
          fi

      - name: "ğŸ’¾ æäº¤æ•°æ®æ›´æ–°"
        if: success() # ä»…åœ¨çˆ¬è™«ä»»åŠ¡æˆåŠŸæ—¶æäº¤
        env:
          BRANCH_NAME: ${{ github.event.repository.default_branch }}
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          echo "åŒæ­¥è¿œç¨‹ä»“åº“æœ€æ–°çŠ¶æ€..."
          git fetch origin $BRANCH_NAME
          
          echo "æš‚å­˜æœ¬åœ°æ›´æ”¹..."
          git stash push --include-untracked -m "stash before sync $(date)" || echo "æ— å†…å®¹å¯æš‚å­˜"
          
          echo "ç¡¬é‡ç½®åˆ°è¿œç¨‹åˆ†æ”¯..."
          git reset --hard origin/$BRANCH_NAME
          
          echo "æ¢å¤æš‚å­˜çš„æ›´æ”¹..."
          git stash pop || echo "æ— æš‚å­˜å†…å®¹å¯æ¢å¤"
          
          echo "æ·»åŠ æ‰€æœ‰å˜æ›´æ–‡ä»¶..."
          git add -A
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "ğŸ“­ æœ¬æ¬¡æŠ“å–æœªäº§ç”Ÿæ–°çš„æ•°æ®å˜æ›´ï¼Œæ— éœ€æäº¤ã€‚"
            exit 0
          fi
          
          echo "å‡†å¤‡æäº¤å˜æ›´..."
          TIMESTAMP=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
          COMMIT_MSG="ğŸ”„ çƒ­ç‚¹æ•°æ®æ›´æ–° [$TIMESTAMP] | å…¨å¹³å°æ‰«æ"
          
          # è·å–ç®€çŸ­çš„å˜æ›´æ‘˜è¦ï¼Œç”¨äºæäº¤ä¿¡æ¯
          CHANGE_SUMMARY=$(git diff --cached --name-only | head -3 | sed 's/^/      /')
          if [ ! -z "$CHANGE_SUMMARY" ]; then
            COMMIT_MSG="$COMMIT_MSG"$'\n\næ›´æ–°æ‘˜è¦:'$'\n'"$CHANGE_SUMMARY"
            if [ $(git diff --cached --name-only | wc -l) -gt 3 ]; then
              COMMIT_MSG="$COMMIT_MSG"$'\n      ...ï¼ˆä»¥åŠæ›´å¤šæ–‡ä»¶ï¼‰'
            fi
          fi
          
          git commit -m "$COMMIT_MSG"
          
          echo "æ¨é€å˜æ›´åˆ°è¿œç¨‹ä»“åº“ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰..."
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            if git pull --rebase origin $BRANCH_NAME && git push origin $BRANCH_NAME; then
              echo "âœ… å˜æ›´æ¨é€æˆåŠŸ (ç¬¬ $i æ¬¡å°è¯•)"
              break
            else
              if [ $i -eq $MAX_RETRIES ]; then
                echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•° ($MAX_RETRIES)"
                exit 1
              else
                WAIT_TIME=$((i * 10))
                echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œ${WAIT_TIME}ç§’åé‡è¯• (ç¬¬ $i æ¬¡)..."
                sleep $WAIT_TIME
                # é‡æ–°æ‹‰å–æœ€æ–°ï¼Œè§£å†³å¯èƒ½çš„å†²çª
                git pull --rebase origin $BRANCH_NAME || echo "æ‹‰å–æœ€æ–°ä»£ç æ—¶é‡åˆ°é—®é¢˜ï¼Œç»§ç»­å°è¯•..."
              fi
            fi
          done

      - name: "ğŸ“¤ ä¸Šä¼ è¯¦ç»†æ—¥å¿—ï¼ˆå¤‡æŸ¥ï¼‰"
        if: always() # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ æ—¥å¿—
        uses: actions/upload-artifact@v3
        with:
          name: crawl-logs-${{ github.run_id }}
          path: |
            crawl_full.log
            logs/
          retention-days: 7
