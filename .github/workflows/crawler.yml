name: ğŸ­ ä¸“ä¸šäº§ä¸šå†…å‚ç›‘æµ‹ç³»ç»Ÿ
on:
  # å®æ—¶æ•°æ®é‡‡é›†ï¼šæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: "0 * * * *"  # æ¯å°æ—¶æ•´ç‚¹
  
  # æ—¥æŠ¥ç”Ÿæˆï¼šåŒ—äº¬æ—¶é—´8ç‚¹ï¼ˆå¯¹åº”UTCæ—¶é—´0ç‚¹ï¼‰
    - cron: "0 0 * * *"  # æ¯å¤©UTCæ—¶é—´0ç‚¹
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      operation:
        description: 'é€‰æ‹©æ“ä½œç±»å‹'
        required: true
        default: 'collect'
        type: choice
        options:
          - collect
          - report
          - test

concurrency:
  group: industrial-intelligence-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.10'
  TZ: 'Asia/Shanghai'

jobs:
  # ä»»åŠ¡1ï¼šå®æ—¶æ•°æ®é‡‡é›†ï¼ˆæ¯å°æ—¶ï¼‰
  data-collection:
    if: github.event_name == 'schedule' || (github.event.inputs.operation == 'collect')
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      data_file: ${{ steps.collect.outputs.data_file }}
      timestamp: ${{ steps.timestamp.outputs.timestamp }}
    
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true
          
      - name: âš™ï¸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ğŸ”§ ç”Ÿæˆæ—¶é—´æˆ³
        id: timestamp
        run: |
          echo "timestamp=$(TZ='Asia/Shanghai' date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "date=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          
      - name: ğŸ” é…ç½®æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          [ -f config/config.yaml ] && echo "âœ… config.yaml å­˜åœ¨" || exit 1
          [ -f config/frequency_words.txt ] && echo "âœ… frequency_words.txt å­˜åœ¨" || exit 1
          
      - name: ğŸ“¡ æ•°æ®é‡‡é›†
        id: collect
        env:
          GITHUB_ACTIONS: true
          ENABLE_NOTIFICATION: "false"
          REPORT_MODE: "incremental"
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "ğŸ• å¼€å§‹é‡‡é›†æ•°æ®..."
          python main.py --mode=collect
          
          # æ£€æŸ¥æ•°æ®æ–‡ä»¶
          if [ -f "data/latest_news.json" ]; then
            echo "âœ… æ•°æ®é‡‡é›†å®Œæˆ"
            data_file="data/hourly/data_${{ steps.timestamp.outputs.timestamp }}.json"
            mkdir -p data/hourly
            cp data/latest_news.json "$data_file"
            echo "data_file=$data_file" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ•°æ®æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
      - name: ğŸ’¾ æ•°æ®å½’æ¡£
        run: |
          mkdir -p data/archive/hourly
          cp ${{ steps.collect.outputs.data_file }} data/archive/hourly/
          
      - name: ğŸ“ æäº¤æ•°æ®æ›´æ–°
        if: success()
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git add data/hourly/ data/archive/hourly/
          
          if git diff --cached --quiet; then
            echo "ğŸ“­ æ— æ–°æ•°æ®éœ€è¦æäº¤"
          else
            git commit -m "ğŸ“Š æ•°æ®æ›´æ–°: ${{ steps.timestamp.outputs.timestamp }}"
            
            # é‡è¯•æ¨é€
            for i in {1..3}; do
              echo "å°è¯•æ¨é€ ($i/3)..."
              git pull --rebase && git push && break || sleep 10
            done
          fi
          
  # ä»»åŠ¡2ï¼šæ—¥æŠ¥ç”Ÿæˆï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰
  daily-report:
    needs: data-collection
    if: github.event_name == 'schedule' || (github.event.inputs.operation == 'report')
    runs-on: ubuntu-latest
    timeout-minutes: 30
      
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: âš™ï¸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          
      - name: ğŸ“… è®¾ç½®æ—¥æœŸ
        id: date
        run: |
          target_date=$(TZ='Asia/Shanghai' date -d "yesterday" +'%Y-%m-%d')
          echo "target_date=$target_date" >> $GITHUB_OUTPUT
          
      - name: ğŸ“Š ç”Ÿæˆäº§ä¸šå†…å‚æ—¥æŠ¥
        id: generate
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          REPORT_MODE: "daily"
          ENABLE_NOTIFICATION: "true"
        run: |
          echo "ğŸ“‹ ç”Ÿæˆäº§ä¸šå†…å‚æ—¥æŠ¥..."
          
          # èšåˆå‰24å°æ—¶æ•°æ®
          find data/hourly -name "*.json" -mtime -1 -exec cat {} + > data/daily_aggregated.json 2>/dev/null || true
          
          # ç”Ÿæˆæ—¥æŠ¥
          echo "ğŸ”„ è¿è¡Œä¸»ç¨‹åºç”Ÿæˆæ—¥æŠ¥..."
          python main.py --mode=daily --input=data/daily_aggregated.json
          
          # æ£€æŸ¥è¾“å‡º
          if [ -f "data/daily_report.md" ]; then
            echo "âœ… æ—¥æŠ¥ç”ŸæˆæˆåŠŸ"
            mkdir -p reports
            cp data/daily_report.md "reports/daily_report_${{ steps.date.outputs.target_date }}.md"
          else
            echo "âŒ æ—¥æŠ¥ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
      - name: ğŸ“¤ å‘é€é£ä¹¦é€šçŸ¥
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "ğŸ“¨ å‘é€é£ä¹¦é€šçŸ¥..."
          
          # å‘é€æ—¥æŠ¥å†…å®¹
          if [ -f "reports/daily_report_${{ steps.date.outputs.target_date }}.md" ]; then
            report_content=$(cat "reports/daily_report_${{ steps.date.outputs.target_date }}.md")
            
            # ä½¿ç”¨ä¸»ç¨‹åºå‘é€é€šçŸ¥
            python main.py --send-only --report-file="reports/daily_report_${{ steps.date.outputs.target_date }}.md"
          fi
          
      - name: ğŸ“ å½’æ¡£æŠ¥å‘Š
        run: |
          mkdir -p reports/archive
          cp "reports/daily_report_${{ steps.date.outputs.target_date }}.md" reports/archive/
          
      - name: ğŸ—‘ï¸ æ¸…ç†æ—§æ•°æ®
        run: |
          find data/hourly -name "*.json" -mtime +7 -delete
          find data/archive/hourly -name "*.json" -mtime +30 -delete
          
      - name: ğŸ“ æäº¤æ—¥æŠ¥
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git add reports/
          
          if git diff --cached --quiet; then
            echo "ğŸ“­ æ— æ–°æŠ¥å‘Šéœ€è¦æäº¤"
          else
            git commit -m "ğŸ“‹ äº§ä¸šå†…å‚æ—¥æŠ¥: ${{ steps.date.outputs.target_date }}"
            git push
          fi
