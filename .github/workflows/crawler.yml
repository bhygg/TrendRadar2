name: "专业产业内参监测系统"

on:
  # 定时触发
  schedule:
    - cron: "0 * * * *"  # 每小时整点
    - cron: "0 0 * * *"   # 每天UTC时间0点
  
  # 手动触发
  workflow_dispatch:
    inputs:
      mode:
        description: '运行模式'
        required: false
        default: 'test'
        type: choice
        options:
          - test
          - daily
          - incremental

concurrency:
  group: crawler-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.10'
  TZ: 'Asia/Shanghai'

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: 验证配置文件
        run: |
          echo "检查配置文件..."
          if [ ! -f config/config.yaml ]; then
            echo "错误: config/config.yaml 不存在"
            exit 1
          fi
          if [ ! -f config/frequency_words.txt ]; then
            echo "错误: config/frequency_words.txt 不存在"
            exit 1
          fi
          echo "配置文件检查通过"
          
      - name: 运行爬虫
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          REPORT_MODE: ${{ github.event.inputs.mode || 'test' }}
          GITHUB_ACTIONS: true
        run: |
          echo "开始运行爬虫..."
          echo "运行模式: $REPORT_MODE"
          
          # 设置环境变量
          if [ "$REPORT_MODE" = "test" ]; then
            export ENABLE_NOTIFICATION="true"
            export REPORT_MODE="daily"
          elif [ "$REPORT_MODE" = "daily" ]; then
            export ENABLE_NOTIFICATION="true"
            export REPORT_MODE="daily"
          else
            export ENABLE_NOTIFICATION="false"
            export REPORT_MODE="incremental"
          fi
          
          # 运行主程序
          python main.py
          
          echo "爬虫运行完成"
          
      - name: 检查输出
        run: |
          echo "检查输出文件..."
          if [ -d "output" ]; then
            echo "输出目录存在"
            find output -type f | head -10
          else
            echo "警告: output目录不存在"
          fi
          
      - name: 提交数据
        if: success()
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          # 添加所有更改
          git add -A
          
          if git diff --cached --quiet; then
            echo "没有更改需要提交"
          else
            TIMESTAMP=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
            git commit -m "自动更新: $TIMESTAMP"
            
            # 重试推送
            for i in {1..3}; do
              echo "尝试推送 ($i/3)..."
              if git pull --rebase && git push; then
                echo "推送成功"
                break
              else
                echo "推送失败，等待10秒..."
                sleep 10
              fi
            done
          fi
