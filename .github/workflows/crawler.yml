name: "èˆ†è®ºçƒ­ç‚¹ç›‘æµ‹ç³»ç»Ÿ - å®æ—¶ç›‘æ§"

on:
  # ç›‘æµ‹é¢‘ç‡ï¼šæ¯30åˆ†é’Ÿä¸€æ¬¡
  schedule:
    - cron: "*/30 * * * *"  # æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      frequency:
        description: 'ç›‘æµ‹é¢‘ç‡'
        required: false
        default: '30min'
        type: choice
        options:
          - '30min'
          - '1hour'
          - '3hour'
          - '6hour'
      mode:
        description: 'ç›‘æµ‹æ¨¡å¼'
        required: false
        default: 'normal'
        type: choice
        options:
          - 'normal'
          - 'deep'
          - 'emergency'

concurrency:
  group: hotspot-monitor
  cancel-in-progress: false

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.10'
  TZ: 'Asia/Shanghai'

jobs:
  # å®æ—¶ç›‘æµ‹ä»»åŠ¡
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: æ£€æŸ¥é…ç½®
        run: |
          echo "ğŸ”§ æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          if [ -f "config.yaml" ]; then
            echo "âœ… config.yaml å­˜åœ¨"
          else
            echo "âŒ config.yaml ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ -f "frequency_words.txt" ]; then
            echo "âœ… frequency_words.txt å­˜åœ¨"
          else
            echo "âŒ frequency_words.txt ä¸å­˜åœ¨"
            exit 1
          fi
          
      - name: è¿è¡Œçƒ­ç‚¹ç›‘æµ‹
        env:
          GITHUB_ACTIONS: true
          ENABLE_NOTIFICATION: "true"
          REPORT_MODE: "incremental"
          # åŒæœºå™¨äººé…ç½®
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          FEISHU_WEBHOOK_URL_2: ${{ secrets.FEISHU_WEBHOOK_URL_2 }}
          # å¯é€‰ï¼šæ ¹æ®è¾“å…¥è°ƒæ•´æ¨¡å¼
          MONITOR_MODE: ${{ github.event.inputs.mode }}
        run: |
          echo "ğŸ” å¼€å§‹èˆ†è®ºçƒ­ç‚¹å®æ—¶ç›‘æµ‹..."
          echo "â° ç›‘æµ‹æ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“Š ç›‘æµ‹æ¨¡å¼: $MONITOR_MODE"
          
          # è¿è¡Œç›‘æµ‹ç¨‹åº
          python main.py
          
          echo "âœ… ç›‘æµ‹å®Œæˆ"
          
      - name: å¤„ç†ç›‘æµ‹ç»“æœ
        if: success()
        run: |
          echo "ğŸ“‹ å¤„ç†ç›‘æµ‹ç»“æœ..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®
          if [ -d "output" ]; then
            echo "ğŸ“ è¾“å‡ºç›®å½•å­˜åœ¨"
            find output -name "*.json" -type f | head -5 | while read file; do
              echo "ğŸ“„ æ–‡ä»¶: $(basename $file)"
            done
          else
            echo "ğŸ“­ æ— è¾“å‡ºæ•°æ®"
          fi
          
      - name: æäº¤æ›´æ–°
        if: success()
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          # åªæäº¤outputç›®å½•
          if [ -d "output" ]; then
            echo "ğŸ“¤ æäº¤outputç›®å½•..."
            
            # æ·»åŠ outputç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
            git add output/
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            if git diff --cached --quiet; then
              echo "ğŸ“­ æ— æ–°æ•°æ®éœ€è¦æäº¤"
            else
              TIMESTAMP=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
              git commit -m "ğŸ“ˆ çƒ­ç‚¹ç›‘æµ‹æ›´æ–°: $TIMESTAMP"
              
              # é‡è¯•æœºåˆ¶
              for i in {1..3}; do
                echo "ğŸ”„ å°è¯•æ¨é€ (ç¬¬$iæ¬¡)..."
                if git pull --rebase && git push; then
                  echo "âœ… æ¨é€æˆåŠŸ"
                  break
                else
                  echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’..."
                  sleep 10
                fi
              done
            fi
          else
            echo "ğŸ“­ outputç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€æäº¤"
          fi
          
      - name: æ¸…ç†å·¥ä½œç©ºé—´
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´..."
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf __pycache__ || true
          rm -f *.log || true
