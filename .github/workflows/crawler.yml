name: Hot News Crawler
on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: crawler-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML feedparser
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          
      - name: Verify required files
        run: |
          echo "æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          if [ ! -f config/config.yaml ]; then
            echo "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
            mkdir -p config
            cat > config/config.yaml << 'EOF'
          app:
            version_check_url: "https://raw.githubusercontent.com/sansan0/TrendRadar/refs/heads/master/version"
            show_version_update: true

          crawler:
            request_interval: 1000
            enable_crawler: true
            use_proxy: false

          report:
            mode: "current"
            rank_threshold: 5

          notification:
            enable_notification: true
            webhooks:
              feishu_url: "{{FEISHU_WEBHOOK_URL}}"

          platforms:
            - id: "weibo"
              name: "å¾®åš"
            - id: "zhihu"
              name: "çŸ¥ä¹Ž"
            - id: "toutiao"
              name: "ä»Šæ—¥å¤´æ¡"
          EOF
          fi
          
          if [ ! -f config/frequency_words.txt ]; then
            echo "åˆ›å»ºå…³é”®è¯æ–‡ä»¶..."
            cat > config/frequency_words.txt << 'EOF'
          ä¸­å›½
          ç¾Žå›½
          ç»æµŽ
          ç§‘æŠ€
          è‚¡å¸‚
          åŽä¸º
          ç‰¹æ–¯æ‹‰
          äººå·¥æ™ºèƒ½
          èŠ¯ç‰‡
          ç–«æƒ…
          EOF
          fi
          
      - name: Test Feishu connection
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "æµ‹è¯•é£žä¹¦è¿žæŽ¥..."
          if [ -z "$FEISHU_WEBHOOK_URL" ]; then
            echo "é”™è¯¯ï¼šFEISHU_WEBHOOK_URL æœªè®¾ç½®"
            exit 1
          fi
          
          echo "é£žä¹¦webhook URLå·²è®¾ç½®ï¼ˆéšè—ï¼‰"
          echo "URLé•¿åº¦ï¼š${#FEISHU_WEBHOOK_URL}"
          
          # å‘é€æµ‹è¯•æ¶ˆæ¯
          TEST_RESPONSE=$(curl -s -w "%{http_code}" -X POST "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "ðŸ”„ TrendRadar æµ‹è¯•æ¶ˆæ¯\næ—¶é—´ï¼š'"$(date '+%Y-%m-%d %H:%M:%S')"'\nçŠ¶æ€ï¼šçˆ¬è™«å³å°†å¯åŠ¨"
              }
            }')
          
          HTTP_CODE=$(echo "$TEST_RESPONSE" | tail -1)
          RESPONSE_BODY=$(echo "$TEST_RESPONSE" | sed '$d')
          
          echo "HTTPå“åº”ç ï¼š$HTTP_CODE"
          echo "å“åº”å†…å®¹ï¼š$RESPONSE_BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… é£žä¹¦è¿žæŽ¥æµ‹è¯•æˆåŠŸ"
          else
            echo "âŒ é£žä¹¦è¿žæŽ¥æµ‹è¯•å¤±è´¥"
            echo "è¯·æ£€æŸ¥ï¼š"
            echo "1. é£žä¹¦æœºå™¨äººæ˜¯å¦å·²æ·»åŠ åˆ°ç¾¤ç»„"
            echo "2. é£žä¹¦æœºå™¨äººå®‰å…¨è®¾ç½®æ˜¯å¦åŒ…å«'çƒ­ç‚¹'å…³é”®è¯"
            echo "3. Webhook URLæ˜¯å¦æ­£ç¡®"
          fi
          
      - name: Run crawler
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          GITHUB_ACTIONS: true
        run: |
          echo "å¼€å§‹æ›¿æ¢é…ç½®æ–‡ä»¶ä¸­çš„å˜é‡..."
          
          # ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨
          if [ ! -f config/config.yaml ]; then
            echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # å¤‡ä»½åŽŸå§‹é…ç½®
          cp config/config.yaml config/config.yaml.bak
          
          # æ›¿æ¢é£žä¹¦URL
          sed -i "s|{{FEISHU_WEBHOOK_URL}}|$FEISHU_WEBHOOK_URL|g" config/config.yaml
          
          echo "æ›¿æ¢åŽçš„feishu_urlé…ç½®ï¼š"
          grep -n "feishu_url" config/config.yaml
          
          echo "è¿è¡Œçˆ¬è™«..."
          python main.py
          
          echo "æ£€æŸ¥è¾“å‡º..."
          if [ -d "output" ]; then
            echo "è¾“å‡ºæ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la output/
            
            if [ -f "output/notification_log.txt" ]; then
              echo "é€šçŸ¥æ—¥å¿—å†…å®¹ï¼š"
              cat output/notification_log.txt
            fi
          fi
          
      - name: Check notification status
        if: always()
        run: |
          echo "æ£€æŸ¥è¿è¡Œç»“æžœ..."
          if [ -f "output/latest_news.txt" ]; then
            NEWS_COUNT=$(grep -c "^\[" output/latest_news.txt || echo "0")
            echo "æœ¬æ¬¡çˆ¬å–åˆ° $NEWS_COUNT æ¡æ–°é—»"
            
            if [ -f "output/notification_sent.txt" ]; then
              echo "âœ… é€šçŸ¥å·²å‘é€"
              cat output/notification_sent.txt
            else
              echo "âš ï¸ é€šçŸ¥æœªå‘é€ï¼Œå¯èƒ½åŽŸå› ï¼š"
              echo "1. æ²¡æœ‰åŒ¹é…çš„æ–°é—»"
              echo "2. é£žä¹¦å‘é€å¤±è´¥"
              echo "3. é…ç½®æ–‡ä»¶é€šçŸ¥æœªå¯ç”¨"
            fi
          fi
          
      - name: Commit and push if changes
        if: success()
        env:
          BRANCH_NAME: ${{ github.event.repository.default_branch }}
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          git fetch origin $BRANCH_NAME
          git stash --include-untracked || echo "Nothing to stash"
          git reset --hard origin/$BRANCH_NAME
          git stash pop || echo "Nothing to pop"
          
          git add -A
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          TIMESTAMP=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
          git commit -m "Auto update at $TIMESTAMP"
          
          for i in {1..3}; do
            git pull --rebase origin $BRANCH_NAME && git push origin $BRANCH_NAME && {
              echo "Successfully pushed"
              exit 0
            }
            echo "Attempt $i failed, waiting $((i*5)) seconds..."
            sleep $((i*5))
          done
