name: 'ðŸ“Š çƒ­ç‚¹é›·è¾¾ - æ—¥åº¦æ±‡æ€» (æ¯æ—¥)'

on:
  schedule:
    # æ¯å¤©åœ¨ UTC 12:00 è¿è¡Œä¸€æ¬¡ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ 20:00 (æ™šä¸Š8ç‚¹)
    # æ‚¨å¯ä»¥é€šè¿‡è°ƒæ•´UTCæ—¶é—´æ¥æŽ§åˆ¶æŽ¨é€æ—¶é—´ï¼Œå…¬å¼ï¼šåŒ—äº¬æ—¶é—´ = UTCæ—¶é—´ + 8å°æ—¶
    - cron: '0 12 * * *'
  workflow_dispatch:

concurrency:
  group: daily-crawler-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 35 # æ—¥åº¦æ±‡æ€»éœ€æŠ“å–å…¨é‡æ•°æ®ï¼Œæ—¶é—´ç¨é•¿

    steps:
      - name: 'ðŸ“¥ æ£€å‡ºä»£ç '
        uses: actions/checkout@v3

      - name: 'ðŸ è®¾ç½®Python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 'ðŸ“¦ å®‰è£…ä¾èµ–'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: 'âœ… éªŒè¯é…ç½®ï¼ˆæ—¥åº¦æ¨¡å¼ï¼‰'
        run: |
          echo "=== æ—¥åº¦æ±‡æ€»æ¨¡å¼ ==="
          echo "æ¨¡å¼: daily (æ±‡æ€»å½“æ—¥æ‰€æœ‰åŒ¹é…æ–°é—»)"
          echo "è§¦å‘: æ¯æ—¥ä¸€æ¬¡"
          echo "ç›®æ ‡: å…¨æ™¯å›žé¡¾ã€æŠŠæ¡è¶‹åŠ¿"
          if [ ! -f config/config.yaml ]; then exit 1; fi
          if [ ! -f config/frequency_words.txt ]; then exit 1; fi
          echo "é…ç½®éªŒè¯é€šè¿‡ã€‚"

      - name: 'ðŸš€ è¿è¡Œçˆ¬è™« (æ—¥åº¦æ¨¡å¼)'
        env:
          GITHUB_ACTIONS: true
          TREND_RADAR_MODE: 'daily' # æ ¸å¿ƒï¼šå¼ºåˆ¶è®¾ç½®ä¸ºæ—¥åº¦æ±‡æ€»æ¨¡å¼
          # é€šçŸ¥ç›¸å…³ Secrets (å»ºè®®é…ç½®ï¼ŒæŽ¨é€å†…å®¹å¤šï¼Œæ›´é‡è¦)
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          # å¯æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼çš„Secret
        run: |
          echo "å¼€å§‹æ—¥åº¦å…¨é‡æŠ“å–ä¸Žæ±‡æ€»..."
          echo "çŽ¯å¢ƒå˜é‡ TREND_RADAR_MODE=$TREND_RADAR_MODE"
          python main.py 2>&1 | tee -a daily_run.log
          echo "æ—¥åº¦æ±‡æ€»æ‰§è¡Œå®Œæ¯•ã€‚"

      - name: 'ðŸ“ˆ æäº¤æ—¥åº¦æ•°æ®'
        if: success()
        env:
          BRANCH_NAME: ${{ github.event.repository.default_branch }}
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git fetch origin $BRANCH_NAME
          git add -A
          DATE_TAG=$(TZ=Asia/Shanghai date "+%Y-%m-%d")
          git commit -m "ðŸ“Š æ—¥åº¦æ•°æ®å½’æ¡£ [$DATE_TAG]" || echo "æ— æ–°æ•°æ®å¯æäº¤"
          git pull --rebase origin $BRANCH_NAME 2>/dev/null || true
          git push origin $BRANCH_NAME