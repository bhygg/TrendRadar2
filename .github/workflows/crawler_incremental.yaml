name: 'ðŸ†• çƒ­ç‚¹é›·è¾¾ - å¢žé‡ç›‘æŽ§ (æ¯å°æ—¶)'

on:
  schedule:
    # æ¯å°æ—¶çš„ç¬¬0åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´å‡8å°æ—¶)
    # ä¾‹å¦‚ UTC 0:00 å¯¹åº” åŒ—äº¬ 8:00ï¼Œä»¥æ­¤ç±»æŽ¨
    - cron: '0 * * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

concurrency:
  group: incremental-crawler-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 25 # å¢žé‡æ¨¡å¼è¿è¡Œè¾ƒå¿«

    steps:
      - name: 'ðŸ“¥ æ£€å‡ºä»£ç '
        uses: actions/checkout@v3

      - name: 'ðŸ è®¾ç½®Python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 'ðŸ“¦ å®‰è£…ä¾èµ–'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: 'âœ… éªŒè¯é…ç½®ï¼ˆå¢žé‡æ¨¡å¼ï¼‰'
        run: |
          echo "=== å¢žé‡ç›‘æŽ§æ¨¡å¼ ==="
          echo "æ¨¡å¼: incremental (ä»…æŠ“å–å¹¶æŽ¨é€æ–°å¢žæ–°é—»)"
          echo "è§¦å‘: æ¯å°æ—¶"
          echo "ç›®æ ‡: é›¶é‡å¤ã€å³æ—¶æé†’"
          if [ ! -f config/config.yaml ]; then exit 1; fi
          if [ ! -f config/frequency_words.txt ]; then exit 1; fi
          echo "é…ç½®éªŒè¯é€šè¿‡ã€‚"

      - name: 'ðŸš€ è¿è¡Œçˆ¬è™« (å¢žé‡æ¨¡å¼)'
        env:
          GITHUB_ACTIONS: true
          TREND_RADAR_MODE: 'incremental' # æ ¸å¿ƒï¼šå¼ºåˆ¶è®¾ç½®ä¸ºå¢žé‡æ¨¡å¼
          # é€šçŸ¥ç›¸å…³ Secrets (æŒ‰éœ€é…ç½®)
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          # å¯æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼çš„Secretï¼Œä¾‹å¦‚ï¼š
          # DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
        run: |
          echo "å¼€å§‹å¢žé‡æŠ“å–..."
          echo "çŽ¯å¢ƒå˜é‡ TREND_RADAR_MODE=$TREND_RADAR_MODE"
          python main.py 2>&1 | tee -a incremental_run.log
          echo "å¢žé‡æŠ“å–æ‰§è¡Œå®Œæ¯•ã€‚"

      - name: 'ðŸ’¾ æäº¤å¢žé‡æ•°æ®'
        if: success()
        env:
          BRANCH_NAME: ${{ github.event.repository.default_branch }}
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git fetch origin $BRANCH_NAME
          git add -A
          if git diff --cached --quiet; then
            echo "ðŸ”„ æœ¬æ¬¡å¢žé‡æŠ“å–æœªå‘çŽ°æ–°å†…å®¹ã€‚"
            exit 0
          fi
          TIMESTAMP=$(TZ=Asia/Shanghai date "+%H:%M")
          git commit -m "ðŸ†• å¢žé‡æ›´æ–° [$TIMESTAMP]"
          # ç®€åŒ–æŽ¨é€ï¼Œé¿å…å¤æ‚é‡è¯•é€»è¾‘
          git pull --rebase origin $BRANCH_NAME 2>/dev/null || true
          git push origin $BRANCH_NAME